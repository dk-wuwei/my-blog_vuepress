---
date: 2021-11-08
title: Vue2è§£æexcelæ•°æ®
vssue-title: Vue2è§£æexcelæ•°æ®
tags:
  - Vue
---

ç”¨æœ€ç®€å•çš„æ–¹å¼ä½¿ç”¨Vue2 + Web Worker +  js-xlsx è§£æexcelæ•°æ®

<!-- more -->

**æœ¬æ–‡é‡ç‚¹åœ¨äºå®ç°åŠŸèƒ½ï¼Œæ²¡æœ‰è¿‡å¤šå»å…³æ³¨å…¶ä»–ã€‚** å°±æƒ³ä½¿ç”¨çš„è¯ç›´æ¥cvåˆ°è‡ªå·±çš„é¡¹ç›®å³å¯ï¼Œæƒ³æ·±å…¥å­¦ä¹ ä¸‹è¾¹ä¹Ÿæœ‰å®˜æ–¹ç½‘å€è‡ªè¡ŒæŸ¥çœ‹å’¯ğŸº

ç”±[SheetJS](https://links.jianshu.com/go?to=https%3A%2F%2Fsheetjs.com%2F)å‡ºå“çš„`js-xlsx`æ˜¯ä¸€æ¬¾éå¸¸æ–¹ä¾¿çš„åªéœ€è¦çº¯JSå³å¯è¯»å–å’Œå¯¼å‡ºexcelçš„å·¥å…·åº“ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒæ ¼å¼ä¼—å¤šï¼Œæ”¯æŒxlsã€xlsxã€ods(ä¸€ç§OpenOfficeä¸“æœ‰è¡¨æ ¼æ–‡ä»¶æ ¼å¼)ç­‰åå‡ ç§æ ¼å¼ã€‚æœ¬æ–‡ä»¥xlsxæ ¼å¼ä¸ºä¾‹ã€‚githubï¼š[https://github.com/SheetJS/sheetjs](https://github.com/SheetJS/sheetjs)

ä¸ºä»€ä¹ˆä½¿ç”¨Web Workerå‘¢ï¼Ÿä¸ºäº†åŠ å¿«è§£æé€Ÿåº¦ï¼Œæé«˜ç”¨æˆ·ä½“éªŒåº¦ğŸ¤¡ã€‚Web Workerå…·ä½“ä»‹ç»çœ‹é˜®è€å¸ˆçš„åšå®¢å°±å¥½ğŸ˜€
[Web Worker ä½¿ç”¨æ•™ç¨‹ - é˜®ä¸€å³°çš„ç½‘ç»œæ—¥å¿—](http://www.ruanyifeng.com/blog/2018/07/web-worker.html)

## æœ¬æ–‡é…å¥—demoä»“åº“ï¼š

**[https://gitee.com/ardeng/worker-xlsx.git](https://gitee.com/ardeng/worker-xlsx.git)**

## æ•ˆæœæ¼”ç¤º

![æ¼”ç¤ºæ•ˆæœ](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d17099415f4a465489d0671abada33d7~tplv-k3u1fbpfcp-watermark.image?)

## ä¸Šä»£ç 

## HTML

**æ™®æ™®é€šé€šã€ç®€ç®€å•å•çš„element ui ä¸Šä¼ ç»„ä»¶**

```js
<el-upload
    ref="input"
    action="/"
    :show-file-list="false"
    :auto-upload="false"
    :on-change="importExcel"
    type="file"
>
    <el-button type="primary">ä¸Šä¼ </el-button>
</el-upload>
```

## JSéƒ¨åˆ†

### å…ˆæ¥ä¸ªæ—  Web Worker ç‰ˆ

Worker çº¿ç¨‹ä¸€æ—¦æ–°å»ºæˆåŠŸï¼Œå°±ä¼šå§‹ç»ˆè¿è¡Œï¼Œä¸ä¼šè¢«ä¸»çº¿ç¨‹ä¸Šçš„æ´»åŠ¨ï¼ˆæ¯”å¦‚ç”¨æˆ·ç‚¹å‡»æŒ‰é’®ã€æäº¤è¡¨å•ï¼‰æ‰“æ–­ã€‚è¿™æ ·æœ‰åˆ©äºéšæ—¶å“åº”ä¸»çº¿ç¨‹çš„é€šä¿¡ã€‚ä½†æ˜¯ï¼Œè¿™ä¹Ÿé€ æˆäº† Worker æ¯”è¾ƒè€—è´¹èµ„æºï¼Œä¸åº”è¯¥è¿‡åº¦ä½¿ç”¨ï¼Œè€Œä¸”ä¸€æ—¦ä½¿ç”¨å®Œæ¯•ï¼Œå°±åº”è¯¥å…³é—­ã€‚

Web Worker æœ‰ä»¥ä¸‹å‡ ä¸ªä½¿ç”¨æ³¨æ„ç‚¹ã€‚

1. **åŒæºé™åˆ¶**  åˆ†é…ç»™ Worker çº¿ç¨‹è¿è¡Œçš„è„šæœ¬æ–‡ä»¶ï¼Œå¿…é¡»ä¸ä¸»çº¿ç¨‹çš„è„šæœ¬æ–‡ä»¶åŒæºã€‚

2. **DOM é™åˆ¶**  Worker çº¿ç¨‹æ‰€åœ¨çš„å…¨å±€å¯¹è±¡ï¼Œä¸ä¸»çº¿ç¨‹ä¸ä¸€æ ·ï¼Œæ— æ³•è¯»å–ä¸»çº¿ç¨‹æ‰€åœ¨ç½‘é¡µçš„ DOM å¯¹è±¡ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨`document`ã€`window`ã€`parent`è¿™äº›å¯¹è±¡ã€‚ä½†æ˜¯ï¼ŒWorker çº¿ç¨‹å¯ä»¥`navigator`å¯¹è±¡å’Œ`location`å¯¹è±¡ã€‚

3. **é€šä¿¡è”ç³»**  Worker çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¸åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå®ƒä»¬ä¸èƒ½ç›´æ¥é€šä¿¡ï¼Œå¿…é¡»é€šè¿‡æ¶ˆæ¯å®Œæˆã€‚

4. **è„šæœ¬é™åˆ¶**  Worker çº¿ç¨‹ä¸èƒ½æ‰§è¡Œ`alert()`æ–¹æ³•å’Œ`confirm()`æ–¹æ³•ï¼Œä½†å¯ä»¥ä½¿ç”¨ XMLHttpRequest å¯¹è±¡å‘å‡º AJAX è¯·æ±‚ã€‚

5. **æ–‡ä»¶é™åˆ¶**  Worker çº¿ç¨‹æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå³ä¸èƒ½æ‰“å¼€æœ¬æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆ`file://`ï¼‰ï¼Œå®ƒæ‰€åŠ è½½çš„è„šæœ¬ï¼Œå¿…é¡»æ¥è‡ªç½‘ç»œã€‚

**ç”±äºä»¥ä¸Šçš„é™åˆ¶ï¼Œæ‰€ä»¥ä¸æƒ³æWorkerä¹Ÿå¯ä»¥ã€‚** ç›´æ¥è§£ææ–‡ä»¶å¯¹è±¡ è½¬æ¢æ•°æ®å³å¯ã€‚

```js
importExcel(file) {
  // éªŒè¯æ–‡ä»¶æ˜¯å¦ä¸ºexcel
  if (!/\.(xlsx|xls|csv)$/.test(file.name)) {
    alert("æ ¼å¼é”™è¯¯ï¼è¯·é‡æ–°é€‰æ‹©")
    return
  }
  this.fileToExcel(file).then(tabJson => {
    // è¿™é‡Œæ‹¿åˆ°excelçš„æ•°æ®
    console.log(tabJson)
  })
},
// excelæ•°æ®è½¬ä¸ºjsonæ•°ç»„
fileToExcel(file) {
  // ä¸ä½¿ç”¨ Promise ä¹Ÿå¯ä»¥ åªæ˜¯æŠŠè¯»æ–‡ä»¶åšæˆå¼‚æ­¥æ›´åˆç†
  return new Promise(function (resolve, reject) {
    const reader = new FileReader()
    reader.onload = function (e) {
        // æ‹¿åˆ°fileæ•°æ®
        const result = e.target.result
        // XLSX è§£æçš„é…ç½®  type: 'binary' å¿…å†™
        const excelData = XLSX.read(result, { type: 'binary' })
        // æ³¨æ„è¦åŠ  { header: 1 }, æ­¤é…ç½®é¡¹ å¯ç”ŸæˆäºŒç»´æ•°ç»„
        const data = XLSX.utils.sheet_to_json(excelData.Sheets[excelData.SheetNames[0]],
                      { header: 1 }) //! è¯»å–å»é™¤å·¥ä½œç°¿ä¸­çš„æ•°æ®
        resolve(data)
      }
      // è°ƒç”¨æ–¹æ³•  è¯»å–äºŒè¿›åˆ¶å­—ç¬¦ä¸²
      reader.readAsBinaryString(file.raw)
    })
  }
```

### Web Workerç‰ˆ

**æƒ³ç”¨Worker ä¸€äº›å‰ç½®å·¥ä½œæ˜¯å¿…ä¸å¯å°‘çš„**

1. ä¸‹è½½ worker-loader

```js
npm i -D worker-loader
```

2. vue.config.jsä¸­é…ç½®loader

```js
// è®¾ç½®è§£æä»¥worker.js ç»“å°¾çš„æ–‡ä»¶ä½¿ç”¨worker-loader è§£æ
chainWebpack: config => {
  config.module.rule('worker')
    .test(/\.worker\.js$/)
    .use('worker-loader')
    .loader('worker-loader')
    .options({ inline: 'fallback' })
}
```

**æ­£å¼è¿›å…¥ä½¿ç”¨Web Worker**

å°è£…ä¸€ä¸‹ Web Worker  å‘½åè§„åˆ™å¦‚ä¸‹ï¼šxxx.worker.js

ä¸‹é¢ä»£ç ä¸­ï¼Œ`self`ä»£è¡¨å­çº¿ç¨‹è‡ªèº«ï¼Œå³å­çº¿ç¨‹çš„å…¨å±€å¯¹è±¡ã€‚

```js
// src\utils\excel.worker.js

import XLSX from 'xlsx'

/**
 * å¤„ç†é”™è¯¯çš„å‡½æ•° ä¸»çº¿ç¨‹å¯ä»¥ç›‘å¬ Worker æ˜¯å¦å‘ç”Ÿé”™è¯¯ã€‚
 * å¦‚æœå‘ç”Ÿé”™è¯¯ï¼ŒWorker ä¼šè§¦å‘ä¸»çº¿ç¨‹çš„`error`äº‹ä»¶ã€‚
 */
const ERROR = () => {
    // å‘é€é”™è¯¯ä¿¡æ¯
    self.postMessage({ message: 'error', data: [] })

    // `self.close()`ç”¨äºåœ¨ Worker å†…éƒ¨å…³é—­è‡ªèº«ã€‚
    self.close()
}

// é”™è¯¯å¤„ç†
self.addEventListener('error', (event) => {
    ERROR()

    // è¾“å‡ºé”™è¯¯ä¿¡æ¯
    console.log('ERROR: Line ', event.lineno, ' in ', event.filename, ': ', event.message)
})

/**
 * @description: Worker çº¿ç¨‹å†…éƒ¨éœ€è¦æœ‰ä¸€ä¸ªç›‘å¬å‡½æ•°ï¼Œç›‘å¬`message`äº‹ä»¶ã€‚ å·¥ä½œçº¿ç¨‹æ¥æ”¶åˆ°ä¸»çº¿ç¨‹çš„æ¶ˆæ¯ 
 * @param {object} event event.data  è·å–åˆ°ä¸»çº¿ç¨‹å‘é€è¿‡æ¥çš„æ•°æ®
 */
self.addEventListener('message', async (event) => {
    // å‘ä¸»çº¿ç¨‹å‘é€æ¶ˆæ¯
    // postMessage(event.data);

    // è§£æexcelæ•°æ®
    parsingExcel(event.data)
}, false)

/**
 * @description: è§£æexcelæ•°æ®
 * @param {object} data.excelFileData æ–‡ä»¶æ•°æ®
 * @param {object} data.config é…ç½®ä¿¡æ¯
 */
const parsingExcel = (data) => {
    try {
        // æ³¨æ„ { header: 1 }, æ­¤é…ç½®é¡¹ å¯ç”ŸæˆäºŒç»´æ•°ç»„
        const { excelFileData, config = { header: 1 } } = data

        // åˆ›å»ºå®ä¾‹åŒ–å¯¹è±¡
        const reader = new FileReader()

        // å¤„ç†æ•°æ®
        reader.onload = function (e) {
            // æ‹¿åˆ°fileæ•°æ®
            const result = e.target.result;
            const excelData = XLSX.read(result, { type: 'binary' })
            const data = XLSX.utils.sheet_to_json(excelData.Sheets[excelData.SheetNames[0]], config) //! è¯»å–å»é™¤å·¥ä½œç°¿ä¸­çš„æ•°æ®

            // å‘é€æ¶ˆæ¯
            self.postMessage({ message: 'success', data })
        };
        // è°ƒç”¨æ–¹æ³•  è¯»å–äºŒè¿›åˆ¶å­—ç¬¦ä¸²
        reader.readAsBinaryString(excelFileData.raw);
    } catch (err) {
        ERROR()
        console.log('è§£æexcelæ•°æ®æ—¶ catchåˆ°çš„é”™è¯¯===>', err)
    }
}
```

**ä½¿ç”¨**

å¼•å…¥æ–‡ä»¶

```js
import Worker from '@/utils/excel.worker.js'
```

ä¸šåŠ¡ç›¸å…³çš„é€»è¾‘

```js
importExcel(file) {
  if (!/\.(xlsx|xls|csv)$/.test(file.name)) {
    alert("æ ¼å¼é”™è¯¯ï¼è¯·é‡æ–°é€‰æ‹©")
    return;
  }
  
  // åˆ›å»ºå®åˆ—
  const worker = new Worker()

  // ä¸»çº¿ç¨‹è°ƒç”¨`worker.postMessage()`æ–¹æ³•ï¼Œå‘ Worker å‘æ¶ˆæ¯
  worker.postMessage({
    excelFileData: file,
    config: { header: 1 }
  })

 // ä¸»çº¿ç¨‹é€šè¿‡`worker.onmessage`æŒ‡å®šç›‘å¬å‡½æ•°ï¼Œæ¥æ”¶å­çº¿ç¨‹å‘å›æ¥çš„æ¶ˆæ¯
  worker.onmessage = (event) => {
    const { message, data } = event.data
    if (message === 'success') {
      // dataæ˜¯ä¸ªäºŒç»´æ•°ç»„ è¡¨å¤´åœ¨ä¸Šè¾¹
      console.log(data)
      // Worker å®Œæˆä»»åŠ¡ä»¥åï¼Œä¸»çº¿ç¨‹å°±å¯ä»¥æŠŠå®ƒå…³æ‰ã€‚
      worker.terminate()
    }
  }
}
```

# å¯èƒ½é‡åˆ°çš„é—®é¢˜

1. `npm run dev`Â å¯åŠ¨ä¸äº†ï¼Œå¹¶ä¸” webpack æŠ¥é”™ï¼šæ£€æŸ¥ä¸‹Â `webpack`Â `worker-loader`Â çš„ç‰ˆæœ¬ã€‚
2. æ§åˆ¶å°æŠ¥é”™åŒ…å«Â `not a function`Â æˆ–Â `not a constructor`ï¼šæ£€æŸ¥ä¸‹ webpck é…ç½®ã€‚æœ€å¥½æ˜¯æŸ¥çœ‹è‹±æ–‡æ–‡æ¡£Â [webpack](https://webpack.js.org/)ï¼Œå› ä¸ºä¸­æ–‡æ–‡æ¡£æ›´æ–°ä¸åŠæ—¶ã€‚
3. æ§åˆ¶å°æŠ¥é”™Â `window is not defined`ï¼šæ”¹æˆÂ `self`Â è¯•è¯•ã€‚å‚è€ƒÂ [Webpack worker-loader - import doesnâ€™t work](https://stackoverflow.com/questions/38747706/webpack-worker-loader-import-doesnt-work)


